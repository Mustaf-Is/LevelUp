<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Habit Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Add JWT decode library -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #fff;
    }
    .sidebar {
      background-color: #1e1e1e;
      height: 100vh;
      padding: 1rem;
    }
    .sidebar .nav-link {
      color: #ccc;
    }
    .sidebar .nav-link.active {
      background-color: #2d2d2d;
      color: #fff;
    }
    .habit-card {
      background-color: #1e1e1e;
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
    }
    .btn-succeed {
      background-color: #2d7d46;
      border: none;
      color: white;
    }
    .modal-content {
      background-color: #1e1e1e;
      color: #fff;
    }
    .modal-header {
      border-bottom: 1px solid #2d2d2d;
    }
    .modal-footer {
      border-top: 1px solid #2d2d2d;
    }
    .form-control, .form-select {
      background-color: #2d2d2d;
      border: 1px solid #444;
      color: #fff;
    }
    .form-control:focus, .form-select:focus {
      background-color: #2d2d2d;
      border-color: #2d7d46;
      color: #fff;
      box-shadow: 0 0 0 0.2rem rgba(45, 125, 70, 0.25);
    }
    .form-label {
      color: #ccc;
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar d-flex flex-column">
      <div class="mb-4 d-flex align-items-center">
        <img src="https://via.placeholder.com/40" class="rounded-circle me-2" alt="Profile">
        <strong id="userDisplayName">User</strong>
      </div>
      <nav class="nav flex-column">
        <a class="nav-link active" href="#">All Habits</a>
        <a class="nav-link" href="#">Afternoon</a>
        <a class="nav-link" href="/categories">Categories</a>
      </nav>
      <div class="mt-4">
        <h6 class="text-muted">AREAS</h6>
        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#addHabitModal">+ Add a Habit</a>
        <h6 class="text-muted mt-3">PREFERENCES</h6>
        <a class="nav-link" href="#">Manage Habits</a>
        <a class="nav-link" href="#">App Settings</a>
        <a class="nav-link" href="#">Resources</a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 p-4">
      <h4>All Habits</h4>
      <p class="text-muted">Loading habits...</p>
      <div id="habitsContainer">
        <!-- Habits will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Add Habit Modal -->
<div class="modal fade" id="addHabitModal" tabindex="-1" aria-labelledby="addHabitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addHabitModalLabel">Add New Habit</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addHabitForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="habitTitle" class="form-label">Title *</label>
              <input type="text" class="form-control" id="habitTitle" name="title" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="habitCategory" class="form-label">Category *</label>
              <select class="form-select" id="habitCategory" name="categoryId" required>
                <option value="">Select a category</option>
                <!-- Categories will be loaded dynamically -->
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label for="habitDescription" class="form-label">Description</label>
            <textarea class="form-control" id="habitDescription" name="description" rows="3"></textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="habitStartDate" class="form-label">Start Date *</label>
              <input type="datetime-local" class="form-control" id="habitStartDate" name="startDate" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="habitEndDate" class="form-label">End Date</label>
              <input type="datetime-local" class="form-control" id="habitEndDate" name="endDate">
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="habitFrequency" class="form-label">Frequency *</label>
              <select class="form-select" id="habitFrequency" name="frequency" required>
                <option value="">Select frequency</option>
                <option value="PERDAY">Per Day</option>
                <option value="PERWEEK">Per Week</option>
                <option value="PERMONTH">Per Month</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="habitTimes" class="form-label">Times *</label>
              <input type="number" class="form-control" id="habitTimes" name="times" min="1" required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-succeed" onclick="createHabit()">Create Habit</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Global variables
  const token = localStorage.getItem('token');

  document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
    loadHabits();
  });

  // Function to decode JWT token and extract user info
  function getUserId() {
    if (!token) {
      return null;
    }
    try {
      const decoded = jwt_decode(token); // Note: jwt_decode not jwtDecode
      console.log('Decoded token:', decoded);
      return decoded.userId;
    } catch (error) {
      console.error('Error decoding JWT:', error);
      return null;
    }
  }

  // Helper function to get auth headers
  function getAuthHeaders() {
    return {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    };
  }

  // Function to initialize authentication
  function initializeAuth() {
    if (!token) {
      alert('No authentication token found. Please log in.');
      window.location.href = '/login';
      return;
    }

    const userId = getUserId();
    console.log(userId);
  }

  // Load categories when the modal is shown
  document.getElementById('addHabitModal').addEventListener('show.bs.modal', function () {
    if (!token) {
      alert('Authentication required. Please log in.');
      window.location.href = '/login';
      return;
    }

    loadCategories();
    // Set default start date to current date/time
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('habitStartDate').value = now.toISOString().slice(0, 16);
  });

  // Function to load categories from the API
  async function loadCategories() {
    try {
      console.log('Loading categories...');
      const response = await fetch('http://localhost:8080/api/categories', {
        method: 'GET',
        headers: getAuthHeaders()
      });

      console.log('Categories response status:', response.status);

      if (response.status === 401) {
        alert('Authentication expired. Please log in again.');
        localStorage.removeItem('token');
        window.location.href = '/login';
        return;
      }

      if (response.ok) {
        const categories = await response.json();
        console.log('Loaded categories:', categories);
        const categorySelect = document.getElementById('habitCategory');

        categorySelect.innerHTML = '<option value="">Select a category</option>';

        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          categorySelect.appendChild(option);
        });
      } else {
        const errorText = await response.text();
        console.error('Failed to load categories:', response.status, errorText);
        alert(`Failed to load categories: ${errorText}`);
      }
    } catch (error) {
      console.error('Error loading categories:', error);
      alert('Error loading categories. Please check your connection.');
    }
  }

  // Function to load habits
  async function loadHabits() {
    try {
      console.log('Loading habits...');
      const response = await fetch('http://localhost:8080/api/habits', {
        method: 'GET',
        headers: getAuthHeaders()
      });

      if (response.ok) {
        const habits = await response.json();
        console.log('Loaded habits:', habits);
        displayHabits(habits);
      } else {
        console.error('Failed to load habits:', response.status);
      }
    } catch (error) {
      console.error('Error loading habits:', error);
    }
  }

  // Function to display habits
  function displayHabits(habits) {
    const container = document.getElementById('habitsContainer');
    if (habits.length === 0) {
      container.innerHTML = '<p class="text-muted">No habits found. Create your first habit!</p>';
      return;
    }

    container.innerHTML = habits.map(habit => `
      <div class="habit-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5>${habit.title}</h5>
            <small class="text-muted">${habit.description || 'No description'}</small>
            <br>
            <small class="text-muted">Frequency: ${habit.frequency} - ${habit.times} times</small>
          </div>
          <button class="btn btn-succeed">Mark as Completed</button>
        </div>
      </div>
    `).join('');
  }

  // Function to create a new habit
  async function createHabit() {
    const form = document.getElementById('addHabitForm');
    const formData = new FormData(form);

    const userId = getUserId();
    if (!token || !userId) {
      alert('Authentication required. Please log in.');
      window.location.href = '/login';
      return;
    }

    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const habitData = {
      title: formData.get('title'),
      description: formData.get('description') || '',
      startDate: formData.get('startDate'),
      endDate: formData.get('endDate') || null,
      frequency: formData.get('frequency'),
      times: parseInt(formData.get('times')),
      userId: userId,
      categoryId: parseInt(formData.get('categoryId'))
    };

    console.log('Creating habit with data:', habitData);

    try {
      const response = await fetch('http://localhost:8080/api/habits', {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify(habitData)
      });

      if (response.status === 401) {
        alert('Authentication expired. Please log in again.');
        localStorage.removeItem('token');
        window.location.href = '/login';
        return;
      }

      if (response.ok) {
        const createdHabit = await response.json();
        console.log('Habit created successfully:', createdHabit);
        alert('Habit created successfully!');

        const modal = bootstrap.Modal.getInstance(document.getElementById('addHabitModal'));
        modal.hide();
        form.reset();
        loadHabits(); // Reload habits
      } else {
        const errorText = await response.text();
        console.error('Failed to create habit:', errorText);
        alert('Failed to create habit. Please check your input and try again.');
      }
    } catch (error) {
      console.error('Error creating habit:', error);
      alert('Error creating habit. Please check your connection and try again.');
    }
  }

  // Clear form when modal is hidden
  document.getElementById('addHabitModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('addHabitForm').reset();
  });
</script>

</body>
</html>